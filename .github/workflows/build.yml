name: Flutter CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Decode Keystore
        run: |
          echo "Decoding keystore.base64 to android/app/turf-buddie-key.jks"
          base64 -d android/app/keystore.base64 > android/app/turf-buddie-key.jks
          ls -l android/app/turf-buddie-key.jks || echo "Keystore file creation failed"

      - name: Create key.properties
        run: |
          echo "Generating key.properties"
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=turf-buddie-alias" >> android/key.properties
          echo "storeFile=android/app/turf-buddie-key.jks" >> android/key.properties
          cat android/key.properties

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release --no-tree-shake-icons

      - name: Prepare Release
        id: prepare_release
        run: |
          VERSION=$(yq e '.version' pubspec.yaml)
          VERSION_NAME=$(echo $VERSION | cut -d'+' -f1)
          VERSION_CODE=$(echo $VERSION | cut -d'+' -f2)
          TAG="v${VERSION_NAME}"
          APK_NAME="tb_app_${VERSION_NAME}.apk"
          mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/${APK_NAME}"
          echo "version_name=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "apk_name=${APK_NAME}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.prepare_release.outputs.tag }} \
            --title "Release ${{ steps.prepare_release.outputs.version_name }}" \
            --notes "Build ${{ steps.prepare_release.outputs.version_code }}" || true
          gh release upload ${{ steps.prepare_release.outputs.tag }} \
            "build/app/outputs/flutter-apk/${{ steps.prepare_release.outputs.apk_name }}"

      - name: Install Firebase CLI and jq
        run: |
          curl -sL https://firebase.tools | bash
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Update Firebase Remote Config
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase use YOUR_FIREBASE_PROJECT_ID --token $FIREBASE_TOKEN
          firebase remoteconfig:get -o template.json --token $FIREBASE_TOKEN
          jq '.parameters.latest_version.defaultValue.value = "${{ steps.prepare_release.outputs.version_name }}"' template.json > temp.json
          mv temp.json template.json
          jq '.parameters.latest_apk_url.defaultValue.value = "https://github.com/${{ github.repository }}/releases/download/${{ steps.prepare_release.outputs.tag }}/${{ steps.prepare_release.outputs.apk_name }}"' template.json > temp.json
          mv temp.json template.json
          firebase deploy --only remoteconfig --token $FIREBASE_TOKEN
