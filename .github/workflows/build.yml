name: "Build & Release"

on:
  push:
    branches:
      - master
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
      - main



jobs:
  build:
    name: Build & Release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
          cache: true

      - name: Get Flutter Dependencies
        run: flutter pub get

      - name: Generate Version Info
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            VERSION_NO_V=${VERSION#v}
          else
            VERSION="v1.0.${{ github.run_number }}"
            VERSION_NO_V="1.0.${{ github.run_number }}"
          fi
          BUILD_NUMBER=${{ github.run_number }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Build: $BUILD_NUMBER"
          echo "Version: $VERSION, Version for pubspec: $VERSION_NO_V, Build: $BUILD_NUMBER"

      - name: Update App Version
        run: |
          sed -i "s/^version: .*/version: ${{ steps.version.outputs.version_no_v }}+${{ steps.version.outputs.build_number }}/" pubspec.yaml
          echo "Updated pubspec.yaml version to: ${{ steps.version.outputs.version_no_v }}+${{ steps.version.outputs.build_number }}"

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/turf-buddie-key.jks
          echo "Keystore decoded successfully"

      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=turf-buddie-key.jks" >> android/key.properties

      - name: Build Release APK
        run: |
          flutter build apk --release --build-number=${{ steps.version.outputs.build_number }}
          echo "APK built successfully"

      - name: Build App Bundle
        run: |
          flutter build appbundle --release --build-number=${{ steps.version.outputs.build_number }}
          echo "App Bundle built successfully"

      - name: Rename APK
        run: |
          mkdir -p release-files
          cp build/app/outputs/flutter-apk/app-release.apk release-files/turf-buddie-${{ steps.version.outputs.version }}.apk
          cp build/app/outputs/bundle/release/app-release.aab release-files/turf-buddie-${{ steps.version.outputs.version }}.aab
          
          # Create version info file for Firebase Remote Config
          cat > release-files/version-info.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "build_number": "${{ steps.version.outputs.build_number }}",
            "release_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "download_url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/turf-buddie-${{ steps.version.outputs.version }}.apk",
            "changelog": "Latest updates and improvements",
            "minimum_supported_version": "v1.0.0",
            "force_update": false
          }
          EOF

      - name: Generate APK Info
        run: |
          APK_SIZE=$(stat -c%s "release-files/turf-buddie-${{ steps.version.outputs.version }}.apk")
          APK_SHA256=$(sha256sum "release-files/turf-buddie-${{ steps.version.outputs.version }}.apk" | cut -d' ' -f1)
          
          echo "APK_SIZE=$APK_SIZE" >> $GITHUB_ENV
          echo "APK_SHA256=$APK_SHA256" >> $GITHUB_ENV
          
          echo "APK Size: $APK_SIZE bytes"
          echo "APK SHA256: $APK_SHA256"

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "release-files/*"
          tag: ${{ steps.version.outputs.version }}
          name: "Release ${{ steps.version.outputs.version }}"
          body: |
            ## ðŸš€ Turf Buddie ${{ steps.version.outputs.version }}
            
            **Build Information:**
            - Version: `${{ steps.version.outputs.version }}`
            - Build Number: `${{ steps.version.outputs.build_number }}`
            - Build Date: `${{ github.event.head_commit.timestamp }}`
            - Commit: [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            
            **Download:**
            - ðŸ“± [Download APK](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/turf-buddie-${{ steps.version.outputs.version }}.apk) (Size: ${{ env.APK_SIZE }} bytes)
            - ðŸ”’ SHA256: `${{ env.APK_SHA256 }}`
            
            **For Firebase Remote Config:**
            ```json
            {
              "latest_version": "${{ steps.version.outputs.version }}",
              "download_url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/turf-buddie-${{ steps.version.outputs.version }}.apk",
              "force_update": false,
              "minimum_version": "v1.0.0"
            }
            ```
            
            ---
            
            ### ðŸ“‹ What's New
            - Latest updates and improvements
            - Bug fixes and performance enhancements
            
            ### ðŸ”„ How to Update
            1. Open the Turf Buddie app
            2. If an update notification appears, tap "Update"
            3. The app will download and install the latest version
            
            > **Note:** This is a direct APK release. Enable "Install from Unknown Sources" if prompted.
          token: ${{ secrets.TOKEN }}
          draft: false
          prerelease: false
          makeLatest: true
          allowUpdates: true

      - name: Get Firebase Access Token
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        id: firebase-token
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          if [[ -n "$FIREBASE_SERVICE_ACCOUNT_KEY" ]]; then
            echo "$FIREBASE_SERVICE_ACCOUNT_KEY" > firebase-service-account.json
          
            # Install gcloud CLI
            curl https://sdk.cloud.google.com | bash > /dev/null
            source ~/.bashrc
            export PATH=$PATH:~/google-cloud-sdk/bin
          
            # Authenticate and get access token
            gcloud auth activate-service-account --key-file=firebase-service-account.json
            ACCESS_TOKEN=$(gcloud auth print-access-token)
            echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
            echo "âœ… Firebase access token obtained"
          
            # Cleanup
            rm -f firebase-service-account.json
          else
            echo "âŒ Firebase service account key not found"
          fi

      - name: Update Firebase Remote Config
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') && steps.firebase-token.outputs.access_token
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          ACCESS_TOKEN: ${{ steps.firebase-token.outputs.access_token }}
        run: |
          echo "ðŸ”„ Updating Firebase Remote Config..."
          
          # Get current Remote Config to preserve etag
          CURRENT_CONFIG=$(curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://firebaseremoteconfig.googleapis.com/v1/projects/$FIREBASE_PROJECT_ID/remoteConfig")
          
          ETAG=$(echo $CURRENT_CONFIG | jq -r '.etag')
          
          # Create updated config
          cat > updated-config.json << EOF
          {
            "parameters": {
              "latest_app_version": {
                "defaultValue": {
                  "value": "${{ steps.version.outputs.version }}"
                },
                "description": "Latest available app version"
              },
              "app_download_url": {
                "defaultValue": {
                  "value": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/turf-buddie-${{ steps.version.outputs.version }}.apk"
                },
                "description": "Direct download URL for the latest APK"
              },
              "force_update_required": {
                "defaultValue": {
                  "value": "false"
                },
                "description": "Whether to force users to update"
              },
              "minimum_supported_version": {
                "defaultValue": {
                  "value": "v1.0.0"
                },
                "description": "Minimum app version that is still supported"
              },
              "update_message": {
                "defaultValue": {
                  "value": "ðŸš€ A new version of Turf Buddie is available! Update now for the latest features and improvements."
                },
                "description": "Message shown to users when update is available"
              },
              "update_title": {
                "defaultValue": {
                  "value": "Update Available"
                },
                "description": "Title for update dialog"
              },
              "changelog": {
                "defaultValue": {
                  "value": "â€¢ Latest updates and improvements\\nâ€¢ Bug fixes and performance enhancements\\nâ€¢ New features for better experience"
                },
                "description": "What's new in this version"
              },
              "release_date": {
                "defaultValue": {
                  "value": "$(date -u +%Y-%m-%d)"
                },
                "description": "Release date of the current version"
              },
              "apk_size_bytes": {
                "defaultValue": {
                  "value": "${{ env.APK_SIZE }}"
                },
                "description": "Size of the APK file in bytes"
              },
              "update_priority": {
                "defaultValue": {
                  "value": "medium"
                },
                "description": "Update priority: low, medium, high, critical"
              }
            }
          }
          EOF
          
          # Update Remote Config
          RESPONSE=$(curl -s -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -H "If-Match: $ETAG" \
            -d @updated-config.json \
            "https://firebaseremoteconfig.googleapis.com/v1/projects/$FIREBASE_PROJECT_ID/remoteConfig")
          
          HTTP_CODE="${RESPONSE: -3}"
          RESPONSE_BODY="${RESPONSE%???}"
          
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "âœ… Firebase Remote Config updated successfully!"
            echo "ðŸ“± App version: ${{ steps.version.outputs.version }}"
            echo "ðŸ”— Download URL: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/turf-buddie-${{ steps.version.outputs.version }}.apk"
          
            # Publish the updated config
            curl -s -X POST \
              -H "Authorization: Bearer $ACCESS_TOKEN" \
              "https://firebaseremoteconfig.googleapis.com/v1/projects/$FIREBASE_PROJECT_ID/remoteConfig:publish"
          
            echo "âœ… Remote Config published and live!"
          
            # Log what was updated for debugging
            echo ""
            echo "ðŸ“‹ Firebase Remote Config Updated With:"
            echo "   â€¢ latest_app_version: ${{ steps.version.outputs.version }}"
            echo "   â€¢ app_download_url: GitHub release URL"
            echo "   â€¢ force_update_required: false"
            echo "   â€¢ minimum_supported_version: v1.0.0"
            echo "   â€¢ update_message: User-friendly update prompt"
            echo "   â€¢ apk_size_bytes: ${{ env.APK_SIZE }}"
            echo ""
            echo "ðŸš€ Users will see update dialog next time they open the app!"
          
          else
            echo "âŒ Failed to update Firebase Remote Config"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
          
            # Try to get more details about the error
            echo ""
            echo "ðŸ” Debugging Information:"
            echo "Project ID: $FIREBASE_PROJECT_ID"
            echo "ETag: $ETAG"
            echo "Access Token Length: ${#ACCESS_TOKEN}"
          
            exit 1
          fi

      - name: Workflow Summary
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        run: |
          echo "ðŸŽ‰ Build and Release Completed Successfully!"
          echo ""
          echo "ðŸ“¦ Release Information:"
          echo "   â€¢ Version: ${{ steps.version.outputs.version }}"
          echo "   â€¢ Build Number: ${{ steps.version.outputs.build_number }}"
          echo "   â€¢ APK Size: ${{ env.APK_SIZE }} bytes"
          echo ""
          echo "ðŸ”— Download Links:"
          echo "   â€¢ APK: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/turf-buddie-${{ steps.version.outputs.version }}.apk"
          echo "   â€¢ AAB: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/turf-buddie-${{ steps.version.outputs.version }}.aab"
          echo ""
          echo "âœ… Users will automatically see update dialog when they open the app!"
          echo "âœ… Firebase Remote Config has been updated with latest version info!"

      - name: Cleanup
        if: always()
        run: |
          rm -f android/app/turf-buddie-key.jks
          rm -f android/key.properties
          echo "Cleanup completed"